# ğŸš€ **MH-CDNet: Map- and History-Aided Change Detection of Traffc Signs in High-Defnition Maps**  

## ğŸ“Œ **é¡¹ç›®æ¦‚è¿°**  
æœ¬é¡¹ç›®æå‡ºäº†ä¸€ç§ **äº¤é€šæ ‡å¿—å˜åŒ–æ£€æµ‹ç³»ç»Ÿ**ï¼Œæ¶µç›– **æ•°æ®å¤„ç†ã€æ¨¡å‹è®­ç»ƒ** åŠ **æ¨¡å‹å¾®è°ƒ** ä¸‰å¤§æ¨¡å—ã€‚è¯¥ç³»ç»Ÿåˆ©ç”¨ **å¤šä¼ æ„Ÿå™¨æ•°æ®èåˆ**ï¼Œç»“åˆ **å†å²è½¨è¿¹ä¸é«˜ç²¾åº¦åœ°å›¾ä¿¡æ¯**ï¼Œå®ç°å¯¹äº¤é€šæ ‡å¿—å˜åŒ–çš„æ™ºèƒ½æ£€æµ‹ä¸æ¨ç†ï¼Œå¹¶ä¼˜åŒ–æ¨¡å‹æ€§èƒ½ä»¥é€‚åº”å®é™…åº”ç”¨åœºæ™¯ã€‚  

---

## ğŸ“‚ **æ•°æ®å¤„ç†**

### ğŸ›  **æ•°æ®è§£æ**
1ï¸âƒ£ **æ‰¹é‡æ•°æ®è§£æ**  
   æœ¬æ¨¡å—ç”¨äº **è‡ªåŠ¨è§£æ** é‡‡é›†åˆ°çš„ **ä½ç½®æ•°æ®ä¸å›¾åƒæ•°æ®**ï¼Œå¹¶å°†è§£æç»“æœå­˜å‚¨è‡³æŒ‡å®šè·¯å¾„ï¼š
   ```bash
   python data_parser/parser/auto_main.py
   ```
   - **ç”Ÿæˆæ—¥å¿—æ–‡ä»¶**ï¼šğŸ“œ `process_files_{i}.log`
   - **è¾“å‡ºè·¯å¾„**ï¼šğŸ“‚ `<server_path>/parser/insdata`

2ï¸âƒ£ **æ‘„åƒå¤´å‚æ•°è§£æ**  
   æœ¬æ¨¡å—è´Ÿè´£æ‘„åƒå¤´å‚æ•°çš„æå–ä¸å¤„ç†ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å‡ ä½•æ ¡æ­£ä¸å‡†ç¡®æ€§ï¼š
   - ä½¿ç”¨ **CAVision** è½¯ä»¶è¿›è¡Œæ‘„åƒå¤´å‚æ•°è§£æ  
   - æå–ä¸å¯¹åº”æ‘„åƒå¤´åŒ¹é…çš„æ ‡å®šæ–‡ä»¶
   ï¼ˆâš  **æ“ä½œéœ€åœ¨è™šæ‹Ÿæœºç¯å¢ƒä¸‹å®Œæˆ**ï¼‰

3ï¸âƒ£ **æ•°æ®åˆ†ç±»**  
   è§£æå®Œæˆåï¼Œéœ€æŒ‰ç…§ **è½¦è¾†ç±»å‹ã€æ—¶é—´åŠè¡Œé©¶è·¯çº¿** å¯¹ `dat` æ–‡ä»¶è¿›è¡Œåˆ†ç±»ï¼Œä»¥ä¾¿åç»­å¤„ç†ï¼š
   ```bash
   python data_parser/process_scene/shutil_dat.py
   ```
   - åˆ†ç±»åçš„æ•°æ®å­˜å‚¨è‡³ï¼šğŸ“‚ `<server_path>/extracted_data`

4ï¸âƒ£ **åœºæ™¯ç­›é€‰**  
   - å°† **å®šä½æ•°æ®æŠ•å½±è‡³ QGIS**ï¼Œå¹¶ **äººå·¥ç­›é€‰** å¯èƒ½åŒ…å«äº¤é€šæ ‡å¿—çš„ **å…³é”®è·¯å£åœºæ™¯**ã€‚  
   - ä¾æ®ç­›é€‰å‡ºçš„ **åœºæ™¯åæ ‡èŒƒå›´** è¿›è¡Œæ•°æ®è¿‡æ»¤ï¼Œæå–ç¬¦åˆæ¡ä»¶çš„ **é‡è®¿æ•°æ®**ï¼š  
   ```bash
   python data_parser/process_scene/shutil_file_to_scene.py
   ```  
   - **åœºæ™¯å®šä¹‰æ–‡ä»¶**ï¼šğŸ“œ `<server_path>/scenes/scenes.csv`  
     æ–‡ä»¶ç¤ºä¾‹ï¼š  
     `1.0 xxx xxx xxx xxx`ï¼ˆç»çº¬åº¦èŒƒå›´ï¼‰  
   - **è¾“å‡ºè·¯å¾„**ï¼šğŸ“‚ `<server_path>/scenes`  
     æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼š  
     ```
     <server_path>/scenes  
         â”œâ”€â”€ 1.0  
         â”‚   â”œâ”€â”€ xxx.dat  
         â”‚   â””â”€â”€ xxx.dat  
         â”œâ”€â”€ 2.0  
         â””â”€â”€ ...  
         â””â”€â”€ scenes.csv  
     ```  

5ï¸âƒ£ **æ•°æ®æ’å€¼**  
   ç”±äºåŸå§‹å›¾åƒè®°å½•é¢‘ç‡ä¸ä½ç½®ä¿¡æ¯è®°å½•é¢‘ç‡ä¸åŒï¼Œä¸ºç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œéœ€è¿›è¡Œ **æ’å€¼å¤„ç†**ï¼š
   ```bash
   python data_parser/process_scene/interplate.py
   ```
   - **ç”Ÿæˆæ’å€¼æ–‡ä»¶**ï¼šğŸ“œ `<dat_path>/interpolated_poses.json`

6ï¸âƒ£ **ç›®æ ‡æ£€æµ‹**  
   æœ¬æ¨¡å—é‡‡ç”¨ **YOLO ç›®æ ‡æ£€æµ‹æ¨¡å‹** è¯†åˆ«åœºæ™¯ä¸­çš„äº¤é€šæ ‡å¿—ï¼Œå¹¶å­˜å‚¨æ£€æµ‹ç»“æœï¼š
   ```bash
   sh data_parser/process_scene/transfer_data.sh
   ```
   - **æ£€æµ‹ç»“æœæ–‡ä»¶**ï¼šğŸ“œ `<dat_path>/detections.json`
   - **è¾“å‡ºè·¯å¾„**ï¼šğŸ“‚ `<server_path>/detected_scenes`

7ï¸âƒ£ **åæ ‡è®¡ç®—**  
   è®¡ç®— **åœºæ™¯ä¸­åŒç±»åˆ«äº¤é€šæ ‡å¿—** çš„åæ ‡ï¼Œå¹¶è§†ä¸ºåŒä¸€å®ä¾‹ï¼š
   ```bash
   python data_parser/process_scene/cal_coordinates.py
   ```
   - **è®¡ç®—ç»“æœæ–‡ä»¶**ï¼šğŸ“œ `<dat_path>/coordinates.json`

     æœ€ç»ˆå¾—åˆ°datæ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼š  
     ```
      <dat_path>/
         â”œâ”€â”€ CD701_000013_2024-05-01_11-30-47/
         â”œâ”€â”€ imu_data.json
         â”œâ”€â”€ interpolated_poses.json
         â”œâ”€â”€ pos_imu_data.json
         â”œâ”€â”€ sda-encode_srv-EncodeSrv.EncodeH265-CAM9/
               â”œâ”€â”€ 6633406207.jpg
               â”œâ”€â”€ 6636839542.jpg
               â”œâ”€â”€ 6640306210.jpg
               â”œâ”€â”€ 6643739544.jpg
               â”œâ”€â”€ 6647206212.jpg
               â”œâ”€â”€ 6650639546.jpg
               â””â”€â”€ ...
         â”œâ”€â”€ sda-encode_srv-EncodeSrv.EncodeH265-CAM9_stream.bin
         â”œâ”€â”€ sda-ins_parser-localization.InsData.dat
         â”œâ”€â”€ sda-ins_parser-localization.InsData-index.dat
         â”œâ”€â”€ wheel_speed_data.json
         â”œâ”€â”€ coordinates.json
         â””â”€â”€ detections.json
     ``` 
     
8ï¸âƒ£ **æ•°æ®é›†æ„å»º**  
   ä¾æ® **åœºæ™¯åæ ‡æ–‡ä»¶** æ„å»ºæ ‡å‡†åŒ–çš„ **äº¤é€šæ ‡å¿—æ•°æ®é›†**ï¼š
   ```bash
   python data_parser/process_sign/sta_coordinates.py
   ```
   - **ç­›é€‰ä¸é‡å‘½å** æ¯ä¸ªè·¯ç‰Œç±»åˆ«çš„æ–‡ä»¶å¤¹ï¼š
     ```bash
     python data_parser/process_sign/filter_traffic_sign_dataset.py
     ```
   - **ç»Ÿè®¡äº¤é€šæ ‡å¿—æ•°æ®é›†ä¿¡æ¯**ï¼ˆåŒ…æ‹¬ç±»åˆ«åˆ†å¸ƒã€æ ‡å¿—æ•°é‡ã€é‡è®¿æ¬¡æ•°åŠè¯¯å·®ï¼‰ï¼š
     ```bash
     python data_parser/process_sign/sta_traffic_sign_dataset.py
     ```
   - **è¾“å‡ºè·¯å¾„**ï¼šğŸ“‚ `<server_path>/traffic_sign_dataset`
     æ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼š  
     ```
     <server_path>/traffic_sign_dataset/
      â”œâ”€â”€ class_2_i5/
         â”œâ”€â”€ sign_1/
            â”œâ”€â”€ errors.json
            â”œâ”€â”€ scenes.json
            â”œâ”€â”€ visit_5_CD701_000013_2024-05-01_14-10-12/
                  â”œâ”€â”€ 6633406207.jpg
                  â”œâ”€â”€ 6636839542.jpg
                  â”œâ”€â”€ 6640306210.jpg
                  â”œâ”€â”€ 6643739544.jpg
                  â”œâ”€â”€ 6647206212.jpg
                  â”œâ”€â”€ 6650639546.jpg
                  â”œâ”€â”€ ...
                  â”œâ”€â”€ data.json
                  â””â”€â”€ max_confidence_image.jpg (ä½œä¸ºæ­¤æ¬¡é‡è®¿çš„ä»£è¡¨)
            â””â”€â”€ ... (ä¸åŒé‡è®¿å®ä¾‹)
         â””â”€â”€ ... (ä¸åŒè·¯ç‰Œå®ä¾‹)
      â””â”€â”€ ... (ä¸åŒè·¯ç‰Œç±»åˆ«)
     ```
     data.jsonç¤ºä¾‹å¦‚ä¸‹ï¼š
     ```
     {
      "scene_folder": "./detected_scenes/26.0/CD701_000013_2024-05-01_14-10-12",
      "class": 2,
      "timestamp": 2837.274168,
      "confidence": 0.9496677673,
      "WGS_Lon": 106.5609265943,
      "WGS_Lat": 29.5879404183,
      "WGS_Alt": 849.1702551395,
      "UTM_X": 651175.4710579601,
      "UTM_Y": 3274144.176355629,
      "UTM_Z": 849.1702551395,
      "max_confidence_image_path": "./detected_scenes/26.0/CD701_000013_2024-05-01_14-10-12/sda-encode_srv-EncodeSrv.EncodeH265-CAM9/2837274168.jpg",
      "x1": 2330.0515136719,
      "y1": 956.8365478516,
      "x2": 2432.85546875,
      "y2": 1061.2010498047,
      "num of imgs": 369,
      "list of imgs": [
         "2820874163.jpg",
         "2820907497.jpg",
         "2820974163.jpg",
         ...
         ]
      }
     ```
---

### ğŸ› **æ•°æ®å¢å¼º**
1ï¸âƒ£ **éšæœºæ•°æ®å¢å¼º**  
   æœ¬æ¨¡å—æ ¹æ®é¢„è®¾çš„ **äº‹ä»¶ç±»å‹æ•°é‡**ï¼Œå¯¹æ•°æ®é›†è¿›è¡Œ **éšæœºå¢å¼º**ï¼š
   ```bash
   python data_parser/augment/random_add.py
   ```

2ï¸âƒ£ **æ•°æ®ç­›é€‰ä¸ç»Ÿè®¡**  
   - **äººå·¥ç­›é€‰** å¢å¼ºåçš„æ•°æ®ï¼Œæ‰¾åˆ°ä¸åŒç±»å‹äº‹ä»¶ï¼š
     ```bash
     python data_parser/augment/find_FP.py
     python data_parser/augment/find_NP.py
     ```
   - **ç»Ÿè®¡æœ€ç»ˆå¢å¼ºåçš„æ•°æ®é›†**ï¼š
     ```bash
     python data_parser/augment/lookup.py
     ```

---

## ğŸ”¥ **æ¨¡å‹è®¾è®¡**

### ğŸ“Š **æ•°æ®é›†æ„å»º**
- **æ•°æ®æ ¼å¼**  
  æ¯æ¡è®°å½•åŒ…å« **è½¦è¾†å¯¹äº¤é€šæ ‡å¿—çš„ä¸€æ¬¡è§‚æµ‹**ï¼Œå¹¶ç»“åˆ **é«˜ç²¾åº¦åœ°å›¾** ä¸ **å†å²æ•°æ®** ä½œä¸ºæ¨¡å‹è¾“å…¥ã€‚  
- **æ•°æ®é›†åˆ’åˆ†**  
  - è®­ç»ƒé›†: æµ‹è¯•é›†: éªŒè¯é›† = **7:2:1**  
  - é‡‡ç”¨ **éšæœºæ‰“ä¹±ç­–ç•¥**ï¼Œç¡®ä¿æ¨¡å‹æ³›åŒ–èƒ½åŠ›  

ğŸ“Œ **æ•°æ®å­—æ®µè¯´æ˜**  
| åˆ—å | æè¿° |
|----------------|------------------------------------------|
| **class_id** | äº¤é€šæ ‡å¿—ç±»åˆ«å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚ `"i10"`ï¼‰ |
| **sign_id** | å…·ä½“äº¤é€šæ ‡å¿—çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| **visit_id** | è®°å½•è½¦è¾†å¯¹è¯¥æ ‡å¿—çš„æŸæ¬¡è§‚æµ‹ |
| **coordinates** | GPS åæ ‡ï¼ˆ`[longitude, latitude]` æ ¼å¼ï¼‰ |
| **image_path** | è§‚æµ‹å›¾åƒæ–‡ä»¶è·¯å¾„ |
| **bbox** | ç›®æ ‡åœ¨å›¾åƒä¸­çš„è¾¹ç•Œæ¡† `[x_min, y_min, x_max, y_max]` |
| **timestamp** | è§‚æµ‹æ—¶é—´ (`YYYY-MM-DD HH:MM:SS`) |
| **confidence** | ç›®æ ‡æ£€æµ‹ç½®ä¿¡åº¦ï¼ˆ0~1ï¼‰ |
| **image_quality_index** | å›¾åƒè´¨é‡è¯„åˆ† |
| **Weather** | æ‹æ‘„æ—¶çš„å¤©æ°”æƒ…å†µï¼ˆ0 = æ™´å¤©ï¼Œ1 = é›¨å¤©ç­‰ï¼‰ |
| **Dayparts** | æ‹æ‘„æ—¶æ®µï¼ˆ0 = ä¸Šåˆï¼Œ1 = ä¸‹åˆç­‰ï¼‰ |
| **Blur**             | å›¾åƒæ¨¡ç³Šç¨‹åº¦ï¼ˆ0 = æ— æ¨¡ç³Šï¼Œ1 = æœ‰æ¨¡ç³Šï¼‰ |  
| **Occlusion**        | ç›®æ ‡é®æŒ¡æƒ…å†µï¼ˆ0 = æ— é®æŒ¡ï¼Œ1 = æœ‰é®æŒ¡ï¼‰ |
| **visit_num_id** | `visit_id` å¯¹åº”çš„æ•°å€¼ç¼–å· |
| **class_num_id** | `class_id` å¯¹åº”çš„æ•°å€¼ç¼–å· |
| **event_type** | è§‚æµ‹äº‹ä»¶ç±»å‹ï¼ˆå¦‚ `"tp"`ï¼‰ |
| **existence** | äº¤é€šæ ‡å¿—æ˜¯å¦å­˜åœ¨ï¼ˆ1 = å­˜åœ¨ï¼Œ0 = ç¼ºå¤±ï¼‰ |

---

### ğŸ¯ **æ¨¡å‹è®­ç»ƒ**
1ï¸âƒ£ **å®Œæ•´æ¨¡å‹è®­ç»ƒ**ï¼ˆåŸºäº **å†å²è½¨è¿¹ + åœ°å›¾ä¿¡æ¯**ï¼‰ï¼š
   ```bash
   python model/train_all.py
   ```

2ï¸âƒ£ **ä»…åŸºäºå†å²è½¨è¿¹è®­ç»ƒ**ï¼š
   ```bash
   python model/train_re.py
   ```

3ï¸âƒ£ **ä»…åŸºäºåœ°å›¾è®­ç»ƒ**ï¼š
   ```bash
   python model/train_map.py
   ```

4ï¸âƒ£ **æ¨¡å‹æµ‹è¯•**ï¼š
   ```bash
   python model/test.py
   ```

---

### ğŸ”¬ **å¯¹æ¯”å®éªŒ**
1ï¸âƒ£ **è´å¶æ–¯æ–¹æ³•**ï¼š
   ```bash
   python model/bayes.py
   ```

2ï¸âƒ£ **Dempster-Shafer ç†è®º**ï¼š
   ```bash
   python model/ds.py
   ```

---

## âš™ **ç¯å¢ƒé…ç½®**
ğŸ“¦ **ä¾èµ–å®‰è£…**
- æ–¹å¼ä¸€ï¼šä½¿ç”¨ YAML æ–‡ä»¶åˆ›å»ºç¯å¢ƒï¼ˆé€‚ç”¨äºè”ç½‘ç¯å¢ƒï¼‰
```bash
conda env create -f environment.yml
```

- æ–¹å¼äºŒï¼šä½¿ç”¨ Conda Pack æ‰“åŒ…ç¯å¢ƒï¼ˆé€‚ç”¨äºç¦»çº¿éƒ¨ç½²ï¼‰   
  å·²ä½¿ç”¨ conda-pack æ‰“åŒ…è¿è¡Œç¯å¢ƒä¸º **`MH-CDNet-env.tar.gz`**ï¼Œé€‚ç”¨äºæ— ç½‘ç»œç¯å¢ƒä¸‹å¿«é€Ÿéƒ¨ç½²ã€‚
   - ğŸ“¦ **ç¯å¢ƒåŒ…è·¯å¾„**: `ssh://125.220.153.57:/home/gyx/project/MH-CDNet/MH-CDNet-env.tar.gz`


ğŸ”§ **å˜é‡å®šä¹‰**
- ğŸ“‚ **`<dat_path>`**ï¼šæŒ‡æ¯ä¸ª `.dat` æ–‡ä»¶è§£æåç”Ÿæˆçš„å¯¹åº”æ–‡ä»¶å¤¹è·¯å¾„ã€‚  
- ğŸ–¥ **`<server_path>`**ï¼šæŒ‡åŸå§‹æ•°æ®æœåŠ¡å™¨å­˜å‚¨è·¯å¾„ `ssh://125.220.153.26/mnt/storage/gyx/`ã€‚

ğŸŒ **æœåŠ¡å™¨è·¯å¾„**
- **æ•°æ®é›†ä»£ç **ï¼š`ssh://125.220.153.57:/home/gyx/project/MH-CDNet/`
- **å®Œæ•´ä»£ç **ï¼š`ssh://125.220.153.57:/home/gyx/project/MH-CDNet_all/`
- **æ‰“åŒ…æ•°æ®é›†**ï¼ˆçº¦ **200GB**ï¼‰ï¼š`ssh://125.220.153.57:/home/gyx/project/MH-CDNet.tar.gz`  

âš  **ç”±äºæ–‡ä»¶å¤§å°é™åˆ¶ï¼ŒGitHub ç›®å‰ä»…æä¾›æ•´ç†åçš„æ•°æ®è¡¨æ ¼ä¸æ ¸å¿ƒä»£ç ã€‚è¿è¡Œä»£ç è¿˜éœ€è¦ä»¥ä¸‹èµ„æºï¼šclip_modelã€traffic_sign_datasetã€traffic_sign_dataset_sample å’Œ traffic_sign_dataset_maskã€‚ä¸‹è½½è¯·å‚è€ƒæ•°æ®é›†ä»£ç è·¯å¾„**
